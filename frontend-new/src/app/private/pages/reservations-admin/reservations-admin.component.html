<app-layout></app-layout>

<div *ngIf="isLoading" class="flex h-64 items-center justify-center">
  <p-progressSpinner></p-progressSpinner>
</div>

<div *ngIf="!isLoading" class="container mx-auto flex flex-col gap-8">
  <div class="mt-4 flex items-center justify-between">
    <h2 class="text-center text-2xl font-bold uppercase text-slate-700">
      Administración de Reservas
    </h2>

    <!-- Componente de filtrado -->
    <app-filter-reservations
      [selectedFilter]="selectedFilter"
      (filter)="applyFilter($event)"
    ></app-filter-reservations>
  </div>

  <div *ngIf="reservations.length === 0" class="text-center">
    No hay reservas.
  </div>

  <div *ngIf="reservations.length > 0" class="flex flex-col gap-4">
    <p-table [value]="filteredReservations" styleClass="p-datatable-striped">
      <ng-template pTemplate="header">
        <tr>
          <th>Imagen</th>
          <th>Título del Juego</th>
          <th>Código</th>
          <th>Usuario</th>
          <th>Fecha de Reserva</th>
          <th>Fecha de Expiración</th>
          <th>Fecha de Devolución</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
      </ng-template>
      <ng-template pTemplate="body" let-reservation>
        <tr>
          <td>
            <img
              [src]="
                reservation.boardGameId?.mainPhoto ||
                'assets/images/nophoto.jpg'
              "
              alt="Imagen del juego"
              class="h-16 w-16 rounded object-cover"
            />
          </td>
          <td>{{ reservation.boardGameId?.title || "Juego no disponible" }}</td>
          <td>
            <span
              class="rounded-md bg-indigo-100 p-2 font-semibold text-indigo-600"
              >{{ reservation.code }}</span
            >
          </td>
          <td>
            <span
              class="rounded-md bg-rose-100 p-2 font-semibold text-rose-500"
              >{{
                reservation.userId?.username || "Usuario no disponible"
              }}</span
            >
          </td>
          <td>{{ reservation.reservationDate | date: "dd/MM/yyyy" }}</td>
          <td>
            {{
              reservation.expirationDate
                ? (reservation.expirationDate | date: "dd/MM/yyyy")
                : "-"
            }}
          </td>
          <td>
            {{
              reservation.returnDate
                ? (reservation.returnDate | date: "dd/MM/yyyy")
                : "-"
            }}
          </td>
          <td>
            <p>
              <span
                [ngClass]="{
                  'bg-blue-100 text-blue-600':
                    reservation.status === 'Accepted',
                  'bg-yellow-100 text-yellow-600':
                    reservation.status === 'Pending',
                  'bg-red-100 text-red-600': reservation.status === 'Rejected',
                  'bg-purple-100 text-purple-600':
                    reservation.status === 'Picked Up',
                  'bg-green-100 text-green-600':
                    reservation.status === 'Completed',
                  'bg-orange-100 text-orange-700':
                    reservation.status === 'Cancelled',
                  'bg-gray-300 text-gray-700': reservation.status === 'Expired'
                }"
                class="rounded-md p-2 font-bold"
              >
                {{ reservation.status }}
              </span>
            </p>
          </td>
          <td>
            <div *ngIf="reservation.status === 'Pending'">
              <button
                pButton
                type="button"
                icon="pi pi-check"
                label="Aprobar"
                class="p-button-success mb-1 w-full"
                (click)="acceptReservation(reservation._id)"
              ></button>
              <button
                pButton
                type="button"
                icon="pi pi-times"
                label="Rechazar"
                class="p-button-danger mb-1 w-full"
                (click)="openRejectModal(reservation._id)"
              ></button>
            </div>
            <div *ngIf="reservation.status === 'Accepted'">
              <button
                pButton
                type="button"
                icon="pi pi-shopping-cart"
                label="Recoger"
                class="p-button mb-1 w-full"
                (click)="markAsPickedUp(reservation._id)"
              ></button>
            </div>
            <div
              *ngIf="
                reservation.status === 'Picked Up' ||
                reservation.status === 'Expired'
              "
            >
              <button
                pButton
                type="button"
                icon="pi pi-check"
                label="Completar"
                class="p-button-info mb-1 w-full"
                (click)="markAsCompleted(reservation._id)"
              ></button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>

    <div class="flex justify-center">
      <p-paginator
        [rows]="pageSize"
        [totalRecords]="totalRecords"
        [first]="(currentPage - 1) * pageSize"
        (onPageChange)="paginate($event)"
        styleClass="custom-paginator"
      ></p-paginator>
    </div>
  </div>
</div>

<p-dialog
  header="Rechazar Reserva"
  [(visible)]="displayRejectModal"
  [modal]="true"
  [closable]="false"
  [style]="{ width: '30vw' }"
>
  <div class="p-fluid">
    <div class="p-field">
      <label
        for="rejectionMessage"
        class="block py-2 text-sm font-medium text-gray-700"
        >Motivo del Rechazo</label
      >
      <textarea
        id="rejectionMessage"
        [(ngModel)]="rejectionMessage"
        rows="5"
        pInputTextarea
      ></textarea>
    </div>
  </div>
  <p-footer class="flex justify-center gap-4">
    <button
      pButton
      type="button"
      label="Cancelar"
      icon="pi pi-times"
      (click)="displayRejectModal = false"
      class="p-button"
    ></button>
    <button
      pButton
      type="button"
      label="Rechazar"
      icon="pi pi-check"
      (click)="rejectReservation()"
      class="p-button-danger"
    ></button>
  </p-footer>
</p-dialog>

<p-toast></p-toast>
